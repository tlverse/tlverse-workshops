<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Optimal Individualized Treatment Regimes (optional) | [Workshop] Targeted Learning in the tlverse</title>
<meta name="author" content="Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips">
<meta name="description" content="Ivana Malenica Based on the tmle3mopttx R package by Ivana Malenica, Jeremy Coyle, and Mark van der Laan. Updated: 2021-08-16  5.1 Learning Objectives By the end of this lesson you will be able...">
<meta name="generator" content="bookdown 0.23.1 with bs4_book()">
<meta property="og:title" content="Chapter 5 Optimal Individualized Treatment Regimes (optional) | [Workshop] Targeted Learning in the tlverse">
<meta property="og:type" content="book">
<meta property="og:url" content="https://tlverse.org/tlverse-workshops/optimal-individualized-treatment-regimes-optional.html">
<meta property="og:description" content="Ivana Malenica Based on the tmle3mopttx R package by Ivana Malenica, Jeremy Coyle, and Mark van der Laan. Updated: 2021-08-16  5.1 Learning Objectives By the end of this lesson you will be able...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Optimal Individualized Treatment Regimes (optional) | [Workshop] Targeted Learning in the tlverse">
<meta name="twitter:description" content="Ivana Malenica Based on the tmle3mopttx R package by Ivana Malenica, Jeremy Coyle, and Mark van der Laan. Updated: 2021-08-16  5.1 Learning Objectives By the end of this lesson you will be able...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.9002/transition.js"></script><script src="libs/bs3compat-0.2.5.9002/tabs.js"></script><script src="libs/bs3compat-0.2.5.9002/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body>
<span class="math inline">
  \(\DeclareMathOperator{\expit}{expit}\)
  \(\DeclareMathOperator{\logit}{logit}\)
  \(\DeclareMathOperator*{\argmin}{\arg\!\min}\)
  \(\newcommand{\indep}{\perp\!\!\!\perp}\)
  \(\newcommand{\coloneqq}{\mathrel{=}}\)
  \(\newcommand{\R}{\mathbb{R}}\)
  \(\newcommand{\E}{\mathbb{E}}\)
  \(\newcommand{\M}{\mathcal{M}}\)
  \(\renewcommand{\P}{\mathbb{P}}\)
  \(\newcommand{\I}{\mathbb{I}}\)
  \(\newcommand{\1}{\mathbbm{1}}\)
  </span>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Causal Inference Meets Machine Learning">[Workshop] Targeted Learning in the <code>tlverse</code></a>:
        <small class="text-muted">Causal Inference Meets Machine Learning</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="motivation.html">Motivation</a></li>
<li><a class="" href="tlverse.html"><span class="header-section-number">1</span> Welcome to the tlverse</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">2</span> The Roadmap for Targeted Learning</a></li>
<li><a class="" href="sl3.html"><span class="header-section-number">3</span> Super (Machine) Learning</a></li>
<li><a class="" href="tmle3.html"><span class="header-section-number">4</span> The TMLE Framework</a></li>
<li><a class="active" href="optimal-individualized-treatment-regimes-optional.html"><span class="header-section-number">5</span> Optimal Individualized Treatment Regimes (optional)</a></li>
<li><a class="" href="stochastic-treatment-regimes-optional.html"><span class="header-section-number">6</span> Stochastic Treatment Regimes (optional)</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">7</span> A Primer on the R6 Class System</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tlverse/tlverse-workshops">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="optimal-individualized-treatment-regimes-optional" class="section level1">
<h1>
<span class="header-section-number">5</span> Optimal Individualized Treatment Regimes (optional)<a class="anchor" aria-label="anchor" href="#optimal-individualized-treatment-regimes-optional"><i class="fas fa-link"></i></a>
</h1>
<p><em>Ivana Malenica</em></p>
<p>Based on the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> <code>R</code> package</a>
by <em>Ivana Malenica, Jeremy Coyle, and Mark van der Laan</em>.</p>
<p>Updated: 2021-08-16</p>
<div id="learning-objectives-3" class="section level2">
<h2>
<span class="header-section-number">5.1</span> Learning Objectives<a class="anchor" aria-label="anchor" href="#learning-objectives-3"><i class="fas fa-link"></i></a>
</h2>
<p>By the end of this lesson you will be able to:</p>
<ol style="list-style-type: decimal">
<li>Differentiate dynamic and optimal dynamic treatment interventions from static
interventions.</li>
<li>Explain the benefits and challenges associated with using optimal
individualized treatment regimes in practice.</li>
<li>Contrast the impact of implementing an optimal individualized treatment
regime in the population with the impact of implementing static and dynamic
treatment regimes in the population.</li>
<li>Estimate causal effects under optimal individualized treatment regimes with
the <code>tmle3mopttx</code> <code>R</code> package.</li>
<li>Implement optimal individualized treatment rules based on sub-optimal
rules, or “simple” rules, and recognize the practical benefit of these rules.</li>
<li>Construct “realistic” optimal individualized treatment regimes that respect
real data and subject-matter knowledge limitations on interventions by
only considering interventions that are supported by the data.</li>
<li>Measure variable importance as defined in terms of the optimal individualized
treatment interventions.</li>
</ol>
</div>
<div id="introduction-to-optimal-individualized-interventions" class="section level2">
<h2>
<span class="header-section-number">5.2</span> Introduction to Optimal Individualized Interventions<a class="anchor" aria-label="anchor" href="#introduction-to-optimal-individualized-interventions"><i class="fas fa-link"></i></a>
</h2>
<p>Identifying which intervention will be effective for which patient
based on lifestyle, genetic and environmental factors is a common goal in
precision medicine. One opts to administer the intervention to individuals
who will benefit from it, instead of assigning treatment on a population level.</p>
<ul>
<li><p>This aim motivates a different type of an intervention, as opposed to the static
exposures we might be used to.</p></li>
<li><p>In this chapter, we learn about dynamic
(individualized) interventions that tailor the treatment decision based on the
collected covariates.</p></li>
<li><p>In the statistics community, such a treatment strategy is termed
<strong>individualized treatment regimes</strong> (ITR), and the (counterfactual)
population mean outcome under an ITR is the <strong>value of the ITR</strong>.</p></li>
<li><p>Even more, suppose one wishes to maximize the population mean of an outcome,
where for each individual we have access to some set of measured covariates.
An ITR with the maximal value is referred to as an <strong>optimal ITR</strong> or the
<strong>optimal individualized treatment</strong>. Consequently, the value of an optimal
ITR is termed the <strong>optimal value</strong>, or the <strong>mean under the optimal
individualized treatment</strong>.</p></li>
<li><p>One opts to administer the intervention to individuals who will profit from
it, instead of assigning treatment on a population level. But how do we know
which intervention works for which patient?</p></li>
<li><p>For example, one might seek to improve retention in HIV care. In a randomized
clinical trial, several interventions show efficacy- including appointment
reminders through text messages, small cash incentives for on time clinic
visits, and peer health workers.</p></li>
<li><p>Ideally, we want to improve effectiveness by assigning each patient the
intervention they are most likely to benefit from, as well as improve
efficiency by not allocating resources to individuals that do not need them,
or would not benefit from an intervention.</p></li>
</ul>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-1"></span>
<img src="img/png/DynamicA_Illustration.png" alt="Illustration of a Dynamic Treatment Regime in a Clinical Setting" width="60%"><p class="caption">
FIGURE 5.1: Illustration of a Dynamic Treatment Regime in a Clinical Setting
</p>
</div>
<p>This aim motivates a different type of intervention, as opposed to the static exposures we
might be used to.</p>
<ul>
<li><p>In this chapter, we examine multiple examples of optimal individualized
treatment regimes
and estimate the mean outcome under the ITR
where the candidate rules are restricted to depend only on user-supplied subset of the
baseline covariates.</p></li>
<li><p>In order to accomplish this, we present the <a href="https://github.com/tlverse/tmle3mopttx"><code>tmle3mopttx</code> R
package</a>, which features an
implementation of a recently developed algorithm for computing targeted minimum
loss-based estimates of a causal effect based on optimal ITR for
categorical treatment.</p></li>
<li><p>In particular, we will use <code>tmle3mopttx</code> to estimate
optimal ITR and the corresponding population value,
construct realistic optimal ITRs, and perform variable importance in terms of the
mean under the optimal individualized treatment.</p></li>
</ul>
</div>
<div id="data-structure-and-notation" class="section level2">
<h2>
<span class="header-section-number">5.3</span> Data Structure and Notation<a class="anchor" aria-label="anchor" href="#data-structure-and-notation"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Suppose we observe <span class="math inline">\(n\)</span> independent and identically distributed observations of
the form <span class="math inline">\(O=(W,A,Y) \sim P_0\)</span>. <span class="math inline">\(P_0 \in \mathcal{M}\)</span>, where <span class="math inline">\(\mathcal{M}\)</span> is the
fully nonparametric model.</p></li>
<li><p>Denote <span class="math inline">\(A \in \mathcal{A}\)</span> as categorical treatment, where
<span class="math inline">\(\mathcal{A} \equiv \{a_1, \ldots, a_{n_A} \}\)</span> and <span class="math inline">\(n_A = |\mathcal{A}|\)</span>, with
<span class="math inline">\(n_A\)</span> denoting the number of categories.</p></li>
<li><p>Denote <span class="math inline">\(Y\)</span> as the final outcome, and <span class="math inline">\(W\)</span> a vector-valued collection of baseline
covariates.</p></li>
<li><p>The likelihood of the data admits a factorization, implied by the time ordering of <span class="math inline">\(O\)</span>.
<span class="math display">\[\begin{equation*}\label{eqn:likelihood_factorization}
p_0(O) = p_{Y,0}(Y|A,W) p_{A,0}(A|W) p_{W,0}(W) = q_{Y,0}(Y|A,W) q_{A,0}(A|W) q_{W,0}(W),
\end{equation*}\]</span></p></li>
<li><p>Consequently, we define
<span class="math inline">\(P_{Y,0}(Y|A,W)=Q_{Y,0}(Y|A,W)\)</span>, <span class="math inline">\(P_{A,0}(A|W)=g_0(A|W)\)</span> and <span class="math inline">\(P_{W,0}(W)=Q_{W,0}(W)\)</span> as the
corresponding conditional distributions of <span class="math inline">\(Y\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(W\)</span>.</p></li>
<li><p>We also define <span class="math inline">\(\bar{Q}_{Y,0}(A,W) \equiv E_0[Y|A,W]\)</span>.</p></li>
<li><p>Finally, denote <span class="math inline">\(V\)</span> as a subset of the baseline covariates <span class="math inline">\(W\)</span> that
the optimal individualized rule depends on.</p></li>
</ul>
</div>
<div id="defining-the-causal-effect-of-an-optimal-individualized-intervention" class="section level2">
<h2>
<span class="header-section-number">5.4</span> Defining the Causal Effect of an Optimal Individualized Intervention<a class="anchor" aria-label="anchor" href="#defining-the-causal-effect-of-an-optimal-individualized-intervention"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Consider dynamic treatment rules <span class="math inline">\(V \rightarrow d(V) \in \{a_1, \ldots, a_{n_A} \} \times \{1\}\)</span>,
for assigning treatment <span class="math inline">\(A\)</span> based on <span class="math inline">\(V\)</span>.</p></li>
<li><p>Dynamic treatment regime may be viewed as an intervention in which
<span class="math inline">\(A\)</span> is set equal to a value based on a hypothetical regime <span class="math inline">\(d(V)\)</span>, and <span class="math inline">\(Y_{d(V)}\)</span>
is the corresponding counterfactual outcome under <span class="math inline">\(d(V)\)</span>.</p></li>
<li><p>The goal of any causal analysis motivated by an optimal individualized
intervention is to estimate a parameter defined as the counterfactual mean of the outcome with
respect to the modified intervention distribution.</p></li>
<li><p>Recall causal assumptions:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li>
<strong>Consistency</strong>: <span class="math inline">\(Y^{d(v_i)}_i = Y_i\)</span> in the event <span class="math inline">\(A_i = d(v_i)\)</span>,
for <span class="math inline">\(i = 1, \ldots, n\)</span>.</li>
<li>
<strong>Stable unit value treatment assumption (SUTVA)</strong>: <span class="math inline">\(Y^{d(v_i)}_i\)</span> does
not depend on <span class="math inline">\(d(v_j)\)</span> for <span class="math inline">\(i = 1, \ldots, n\)</span> and <span class="math inline">\(j \neq i\)</span>, or lack
of interference.</li>
<li>
<strong>Strong ignorability</strong>: <span class="math inline">\(A \perp \!\!\! \perp Y^{d(v)} \mid W\)</span>, for all <span class="math inline">\(a \in \mathcal{A}\)</span>.</li>
<li>
<strong>Positivity (or overlap)</strong>: <span class="math inline">\(P_0(\min_{a \in \mathcal{A}} g_0(a|W) &gt; 0)=1\)</span>
</li>
</ol>
<ul>
<li><p>Here, we also assume non-exceptional law is in effect.</p></li>
<li><p>We are primarily interested in the value of an individualized rule,
<span class="math display">\[E_0[Y_{d(V)}] = E_{0,W}[\bar{Q}_{Y,0}(A=d(V),W)].\]</span></p></li>
<li><p>The optimal rule is the rule with the maximal value:
<span class="math display">\[d_{opt}(V) \equiv \text{argmax}_{d(V) \in \mathcal{D}} E_0[Y_{d(V)}] \]</span>
where <span class="math inline">\(\mathcal{D}\)</span> represents the set of possible rules, <span class="math inline">\(d\)</span>, implied by <span class="math inline">\(V\)</span>.</p></li>
<li><p>The target causal estimand of our analysis is:
<span class="math display">\[\psi_0 := E_0[Y_{d_{opt}(V)}] =  E_{0,W}[\bar{Q}_{Y,0}(A=d_{opt}(V),W)].\]</span></p></li>
<li><p>General, high-level idea:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>Learn the optimal ITR using the Super Learner.</p></li>
<li><p>Estimate its value with the cross-validated Targeted Minimum Loss-based
Estimator (CV-TMLE).</p></li>
</ol>
<div id="why-cv-tmle" class="section level3">
<h3>
<span class="header-section-number">5.4.1</span> Why CV-TMLE?<a class="anchor" aria-label="anchor" href="#why-cv-tmle"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>CV-TMLE is necessary as the non-cross-validated TMLE is biased upward for the
mean outcome under the rule, and therefore overly optimistic.</p></li>
<li><p>More generally however, using CV-TMLE allows us more freedom in estimation and
therefore greater data adaptivity, without sacrificing inference!</p></li>
</ul>
</div>
</div>
<div id="binary-treatment" class="section level2">
<h2>
<span class="header-section-number">5.5</span> Binary Treatment<a class="anchor" aria-label="anchor" href="#binary-treatment"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>How do we estimate the optimal individualized treatment regime? In the case of
a binary treatment, a key quantity for optimal ITR is the <strong>blip</strong> function.</p></li>
<li><p>Optimal ITR ideally assigns treatment to individuals falling in strata in
which the stratum specific average treatment effect, the <strong>blip</strong> function, is
positive and does not assign treatment to individuals for which this quantity
is negative.</p></li>
<li><p>We define the blip function as: <span class="math display">\[\bar{Q}_0(V) \equiv E_0[Y_1-Y_0|V] \equiv
E_0[\bar{Q}_{Y,0}(1,W) - \bar{Q}_{Y,0}(0,W) | V], \]</span> or the average treatment
effect within a stratum of <span class="math inline">\(V\)</span>.</p></li>
<li><p>Optimal individualized rule can now be derived as <span class="math inline">\(d_{opt}(V) = I(\bar{Q}_{0}(V) &gt; 0)\)</span>.</p></li>
<li><p>Relying on the Targeted Maximum Likelihood (TML) estimator and the Super
Learner estimate of the blip function, we follow the below steps in order to
obtain value of the ITR:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>Estimate <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> and <span class="math inline">\(g_0(A|W)\)</span> using <code>sl3</code>. We denote such
estimates as <span class="math inline">\(\bar{Q}_{Y,n}(A,W)\)</span> and <span class="math inline">\(g_n(A|W)\)</span>.</p></li>
<li><p>Apply the doubly robust Augmented-Inverse Probability Weighted (A-IPW)
transform to our outcome, where we define:</p></li>
</ol>
<p><span class="math display">\[D_{\bar{Q}_Y,g,a}(O) \equiv \frac{I(A=a)}{g(A|W)} (Y-\bar{Q}_Y(A,W)) + \bar{Q}_Y(A=a,W)\]</span></p>
<p>Note that under the randomization and positivity assumptions we have that
<span class="math inline">\(E[D_{\bar{Q}_Y,g,a}(O) | V] = E[Y_a |V].\)</span> We emphasize the double robust nature
of the A-IPW transform: consistency of <span class="math inline">\(E[Y_a |V]\)</span> will depend on correct estimation
of either <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> or <span class="math inline">\(g_0(A|W)\)</span>. As such, in a randomized trial, we are
guaranteed a consistent estimate of <span class="math inline">\(E[Y_a |V]\)</span> even if we get <span class="math inline">\(\bar{Q}_{Y,0}(A,W)\)</span> wrong!</p>
<p>Using this transform, we can define the following contrast:</p>
<p><span class="math display">\[D_{\bar{Q}_Y,g}(O) = D_{\bar{Q}_Y,g,a=1}(O) - D_{\bar{Q}_Y,g,a=0}(O)\]</span></p>
<p>We estimate the blip function, <span class="math inline">\(\bar{Q}_{0,a}(V)\)</span>, by regressing <span class="math inline">\(D_{\bar{Q}_Y,g}(O)\)</span> on <span class="math inline">\(V\)</span> using
the specified <code>sl3</code> library of learners and an appropriate loss function.</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Our estimated rule is <span class="math inline">\(d(V) = \text{argmax}_{a \in \mathcal{A}} \bar{Q}_{0,a}(V)\)</span>.</p></li>
<li><p>We obtain inference for the mean outcome under the estimated optimal rule using CV-TMLE.</p></li>
</ol>
<div id="evaluating-the-causal-effect-of-an-optimal-itr-with-binary-treatment" class="section level3">
<h3>
<span class="header-section-number">5.5.1</span> Evaluating the Causal Effect of an optimal ITR with Binary Treatment<a class="anchor" aria-label="anchor" href="#evaluating-the-causal-effect-of-an-optimal-itr-with-binary-treatment"><i class="fas fa-link"></i></a>
</h3>
<p>To start, let us load the packages we will use and set a seed for simulation:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/sl3">sl3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/tmle3">tmle3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/tmle3mopttx">tmle3mopttx</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/">devtools</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">116</span><span class="op">)</span></code></pre></div>
<div id="simulate-data" class="section level4">
<h4>
<span class="header-section-number">5.5.1.1</span> Simulate Data<a class="anchor" aria-label="anchor" href="#simulate-data"><i class="fas fa-link"></i></a>
</h4>
<p>Our data generating distribution is of the following form:</p>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{3 \times 3})\]</span>
<span class="math display">\[P(A=1|W) = \frac{1}{1+\exp^{(-0.8*W_1)}}\]</span>
<span class="math display">\[P(Y=1|A,W) = 0.5\text{logit}^{-1}[-5I(A=1)(W_1-0.5)+5I(A=0)(W_1-0.5)] +
0.5\text{logit}^{-1}(W_2W_3)\]</span></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"data_bin"</span><span class="op">)</span></code></pre></div>
<ul>
<li><p>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
<li><p>Note that the mean under the true optimal rule is <span class="math inline">\(\psi_0=0.578\)</span> for this data
generating distribution.</p></li>
<li><p>Next, we specify the role that each variable in the data set plays as the
nodes in a DAG.</p></li>
</ul>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># organize data and nodes for tmle3</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data_bin</span>
<span class="va">node_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span><span class="op">)</span>,
  A <span class="op">=</span> <span class="st">"A"</span>,
  Y <span class="op">=</span> <span class="st">"Y"</span>
<span class="op">)</span></code></pre></div>
<ul>
<li>We now have an observed data structure (<code>data</code>), and a specification of the
role that each variable in the data set plays as the nodes in a DAG.</li>
</ul>
</div>
<div id="constructing-optimal-stacked-regressions-with-sl3" class="section level4">
<h4>
<span class="header-section-number">5.5.1.2</span> Constructing Optimal Stacked Regressions with <code>sl3</code><a class="anchor" aria-label="anchor" href="#constructing-optimal-stacked-regressions-with-sl3"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>We generate three different ensemble learners that must be fit, corresponding
to the learners for the outcome regression, propensity score, and the blip
function.</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define sl3 library and metalearners:</span>
<span class="va">lrn_xgboost_50</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">lrn_xgboost_100</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">lrn_xgboost_500</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">lrn_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>

<span class="co">## Define the Q learner:</span>
<span class="va">Q_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="va">lrn_xgboost_50</span>, <span class="va">lrn_xgboost_100</span>,
    <span class="va">lrn_xgboost_500</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span>
  <span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">## Define the g learner:</span>
<span class="va">g_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_100</span>, <span class="va">lrn_glm</span><span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">## Define the B learner:</span>
<span class="va">b_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="va">lrn_xgboost_50</span>, <span class="va">lrn_xgboost_100</span>,
    <span class="va">lrn_xgboost_500</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span>
  <span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We make the above explicit with respect to standard
notation by bundling the ensemble learners into a list object below:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify outcome and treatment regressions and create learner list</span>
<span class="va">learner_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Q_learner</span>, A <span class="op">=</span> <span class="va">g_learner</span>, B <span class="op">=</span> <span class="va">b_learner</span><span class="op">)</span></code></pre></div>
</div>
<div id="targeted-estimation-of-the-mean-under-the-optimal-individualized-interventions-effects" class="section level4">
<h4>
<span class="header-section-number">5.5.1.3</span> Targeted Estimation of the Mean under the Optimal Individualized Interventions Effects<a class="anchor" aria-label="anchor" href="#targeted-estimation-of-the-mean-under-the-optimal-individualized-interventions-effects"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li><p>To start, we will initialize a specification for the TMLE of our parameter of
interest simply by calling <code>tmle3_mopttx_blip_revere</code>.</p></li>
<li><p>We specify the argument <code>V = c("W1", "W2", "W3")</code> when initializing the
<code>tmle3_Spec</code> object in order to communicate that we’re interested in learning
a rule dependent on <code>V</code> covariates.</p></li>
<li><p>We also need to specify the type of blip we will use in this estimation
problem, and the list of learners used to estimate relevant parts of the
likelihood and the blip function.</p></li>
<li><p>In addition, we need to specify whether we want to maximize or minimize the
mean outcome under the rule (<code>maximize=TRUE</code>).</p></li>
<li><p>If <code>complex=FALSE</code>, <code>tmle3mopttx</code> will consider all the possible rules under a
smaller set of covariates including the static rules, and optimize the mean
outcome over all the suboptimal rules dependent on <span class="math inline">\(V\)</span>.</p></li>
<li><p>If <code>realistic=TRUE</code>, only treatments supported by the data will be considered,
therefore alleviating concerns regarding practical positivity issues.</p></li>
</ul>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip1"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit</span>
<span class="co">#&gt; A tmle3_Fit that took 1 step(s)</span>
<span class="co">#&gt;    type         param init_est tmle_est       se   lower   upper</span>
<span class="co">#&gt; 1:  TSM E[Y_{A=NULL}]  0.43164  0.55855 0.027047 0.50554 0.61156</span>
<span class="co">#&gt;    psi_transformed lower_transformed upper_transformed</span>
<span class="co">#&gt; 1:         0.55855           0.50554           0.61156</span></code></pre></div>
<p>We can see that the confidence interval covers our true mean under the true optimal
individualized treatment!</p>
</div>
</div>
</div>
<div id="categorical-treatment" class="section level2">
<h2>
<span class="header-section-number">5.6</span> Categorical Treatment<a class="anchor" aria-label="anchor" href="#categorical-treatment"><i class="fas fa-link"></i></a>
</h2>
<p><strong>QUESTION:</strong> Can we still use the blip function if the treatment is
categorical?</p>
<ul>
<li><p>In this section, we consider how to evaluate the mean outcome under the
optimal individualized treatment when <span class="math inline">\(A\)</span> has more than two categories!</p></li>
<li><p>We define <strong>pseudo-blips</strong> as vector valued entities where the output for a
given <span class="math inline">\(V\)</span> is a vector of length equal to the number of treatment categories,
<span class="math inline">\(n_A\)</span>. As such, we define it as: <span class="math display">\[\bar{Q}_0^{pblip}(V) =
\{\bar{Q}_{0,a}^{pblip}(V): a \in \mathcal{A} \}\]</span></p></li>
<li><p>We implement three different pseudo-blips in <code>tmle3mopttx</code>.</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p><strong>Blip1</strong> corresponds to choosing a reference category of treatment, and
defining the blip for all other categories relative to the specified
reference: <span class="math display">\[\bar{Q}_{0,a}^{pblip-ref}(V) \equiv E_0(Y_a-Y_0|V)\]</span></p></li>
<li><p><strong>Blip2</strong> approach corresponds to defining the blip relative to the average
of all categories:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-avg}(V) \equiv E_0(Y_a- \frac{1}{n_A} \sum_{a \in \mathcal{A}} Y_a|V)\]</span></p></li>
<li><p><strong>Blip3</strong> reflects an extension of Blip2, where the average is now a weighted
average:
<span class="math display">\[\bar{Q}_{0,a}^{pblip-wavg}(V) \equiv E_0(Y_a- \frac{1}{n_A}
\sum_{a \in \mathcal{A}} Y_{a} P(A=a|V)|V)\]</span></p></li>
</ol>
<div id="evaluating-the-causal-effect-of-an-optimal-itr-with-categorical-treatment" class="section level3">
<h3>
<span class="header-section-number">5.6.1</span> Evaluating the Causal Effect of an optimal ITR with Categorical Treatment<a class="anchor" aria-label="anchor" href="#evaluating-the-causal-effect-of-an-optimal-itr-with-categorical-treatment"><i class="fas fa-link"></i></a>
</h3>
<p>While the procedure is analogous to the previously described binary treatment,
we now need to pay attention to the type of blip we define in the estimation
stage, as well as how we construct our learners.</p>
<div id="simulated-data" class="section level4">
<h4>
<span class="header-section-number">5.6.1.1</span> Simulated Data<a class="anchor" aria-label="anchor" href="#simulated-data"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>First, we load the simulated data. Here, our data generating distribution was
of the following form:</li>
</ul>
<p><span class="math display">\[W \sim \mathcal{N}(\bf{0},I_{4 \times 4})\]</span>
<span class="math display">\[P(A|W) = \frac{1}{1+\exp^{(-(0.05*I(A=1)*W_1+0.8*I(A=2)*W_1+0.8*I(A=3)*W_1))}}\]</span></p>
<p><span class="math display">\[P(Y|A,W) = 0.5\text{logit}^{-1}[15I(A=1)(W_1-0.5) - 3I(A=2)(2W_1+0.5) \\
+ 3I(A=3)(3W_1-0.5)] +\text{logit}^{-1}(W_2W_1)\]</span></p>
<ul>
<li>We can just load the data available as part of the package as follows:</li>
</ul>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"data_cat_realistic"</span><span class="op">)</span></code></pre></div>
<ul>
<li>The above composes our observed data structure <span class="math inline">\(O = (W, A, Y)\)</span>. Note that the
mean under the true optimal rule is <span class="math inline">\(\psi_0=0.658\)</span>, which is the quantity we
aim to estimate.</li>
</ul>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># organize data and nodes for tmle3</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data_cat_realistic</span>
<span class="va">node_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span>, <span class="st">"W4"</span><span class="op">)</span>,
  A <span class="op">=</span> <span class="st">"A"</span>,
  Y <span class="op">=</span> <span class="st">"Y"</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="constructing-optimal-stacked-regressions-with-sl3-1" class="section level4">
<h4>
<span class="header-section-number">5.6.1.2</span> Constructing Optimal Stacked Regressions with <code>sl3</code><a class="anchor" aria-label="anchor" href="#constructing-optimal-stacked-regressions-with-sl3-1"><i class="fas fa-link"></i></a>
</h4>
<p><strong>QUESTION:</strong> With categorical treatment, what is the dimension of the blip now?
How would we go about estimating it?</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialize few of the learners:</span>
<span class="va">lrn_xgboost_50</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">lrn_xgboost_100</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">lrn_xgboost_500</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">lrn_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>

<span class="co">## Define the Q learner, which is just a regular learner:</span>
<span class="va">Q_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_50</span>, <span class="va">lrn_xgboost_100</span>, <span class="va">lrn_xgboost_500</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span><span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define the g learner, which is a multinomial learner:</span>
<span class="co"># specify the appropriate loss of the multinomial learner:</span>
<span class="va">mn_metalearner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_solnp</span>,
  loss_function <span class="op">=</span> <span class="va">loss_loglik_multinomial</span>,
  learner_function <span class="op">=</span> <span class="va">metalearner_linear_multinomial</span>
<span class="op">)</span>
<span class="va">g_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_sl</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_100</span>, <span class="va">lrn_xgboost_500</span>, <span class="va">lrn_mean</span><span class="op">)</span>, <span class="va">mn_metalearner</span><span class="op">)</span>

<span class="co"># Define the Blip learner, which is a multivariate learner:</span>
<span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_xgboost_50</span>, <span class="va">lrn_xgboost_100</span>, <span class="va">lrn_xgboost_500</span>, <span class="va">lrn_mean</span>, <span class="va">lrn_glm</span><span class="op">)</span>
<span class="va">b_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/create_mv_learners.html">create_mv_learners</a></span><span class="op">(</span>learners <span class="op">=</span> <span class="va">learners</span><span class="op">)</span></code></pre></div>
<ul>
<li><p>We generate three different ensemble learners that must be fit,
corresponding to the learners for the outcome regression, propensity score, and the
blip function.</p></li>
<li><p>Note that we need to estimate <span class="math inline">\(g_0(A|W)\)</span> for a categorical <span class="math inline">\(A\)</span>- therefore
we use the multinomial Super Learner option available within the <code>sl3</code> package with learners
that can address multi-class classification problems.</p></li>
<li><p>In order to see which learners can
be used to estimate <span class="math inline">\(g_0(A|W)\)</span> in <code>sl3</code>, we run the following:</p></li>
</ul>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># See which learners support multi-class classification:</span>
<span class="fu"><a href="https://tlverse.org/sl3/reference/list_learners.html">sl3_list_learners</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"categorical"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;  [1] "Lrnr_bound"                "Lrnr_caret"               </span>
<span class="co">#&gt;  [3] "Lrnr_cv_selector"          "Lrnr_glmnet"              </span>
<span class="co">#&gt;  [5] "Lrnr_grf"                  "Lrnr_gru_keras"           </span>
<span class="co">#&gt;  [7] "Lrnr_h2o_glm"              "Lrnr_h2o_grid"            </span>
<span class="co">#&gt;  [9] "Lrnr_independent_binomial" "Lrnr_lightgbm"            </span>
<span class="co">#&gt; [11] "Lrnr_lstm_keras"           "Lrnr_mean"                </span>
<span class="co">#&gt; [13] "Lrnr_multivariate"         "Lrnr_nnet"                </span>
<span class="co">#&gt; [15] "Lrnr_optim"                "Lrnr_polspline"           </span>
<span class="co">#&gt; [17] "Lrnr_pooled_hazards"       "Lrnr_randomForest"        </span>
<span class="co">#&gt; [19] "Lrnr_ranger"               "Lrnr_rpart"               </span>
<span class="co">#&gt; [21] "Lrnr_screener_correlation" "Lrnr_solnp"               </span>
<span class="co">#&gt; [23] "Lrnr_svm"                  "Lrnr_xgboost"</span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify outcome and treatment regressions and create learner list</span>
<span class="va">learner_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Q_learner</span>, A <span class="op">=</span> <span class="va">g_learner</span>, B <span class="op">=</span> <span class="va">b_learner</span><span class="op">)</span></code></pre></div>
</div>
<div id="targeted-estimation-of-the-mean-under-the-optimal-individualized-interventions-effects-1" class="section level4">
<h4>
<span class="header-section-number">5.6.1.3</span> Targeted Estimation of the Mean under the Optimal Individualized Interventions Effects<a class="anchor" aria-label="anchor" href="#targeted-estimation-of-the-mean-under-the-optimal-individualized-interventions-effects-1"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span>, <span class="st">"W3"</span>, <span class="st">"W4"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit</span>
<span class="co">#&gt; A tmle3_Fit that took 1 step(s)</span>
<span class="co">#&gt;    type         param init_est tmle_est       se   lower   upper</span>
<span class="co">#&gt; 1:  TSM E[Y_{A=NULL}]  0.54158  0.65915 0.068054 0.52577 0.79254</span>
<span class="co">#&gt;    psi_transformed lower_transformed upper_transformed</span>
<span class="co">#&gt; 1:         0.65915           0.52577           0.79254</span>

<span class="co"># How many individuals got assigned each treatment?</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmle_spec</span><span class="op">$</span><span class="va">return_rule</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   1   2   3 </span>
<span class="co">#&gt; 428 394 178</span></code></pre></div>
<p>We can see that the confidence interval covers
our true mean under the true optimal individualized treatment.</p>
<p><strong>NOTICE the distribution of the assigned treatment! We will need this shortly.</strong></p>
</div>
</div>
</div>
<div id="extensions-to-causal-effect-of-an-oit" class="section level2">
<h2>
<span class="header-section-number">5.7</span> Extensions to Causal Effect of an OIT<a class="anchor" aria-label="anchor" href="#extensions-to-causal-effect-of-an-oit"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>We consider two extensions to the procedure described for
estimating the value of the ITR.</p></li>
<li><p>The first one considers a setting where the user
might be interested in a grid of possible suboptimal rules, corresponding to
potentially limited knowledge of potential effect modifiers (<strong>Simpler Rules</strong>).</p></li>
<li><p>The second extension concerns implementation of realistic optimal individual
interventions where certain regimes might be preferred, but due to practical or
global positivity restraints are not realistic to implement (<strong>Realistic Interventions</strong>).</p></li>
</ul>
<div id="simpler-rules" class="section level3">
<h3>
<span class="header-section-number">5.7.1</span> Simpler Rules<a class="anchor" aria-label="anchor" href="#simpler-rules"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>In order to not only consider the most ambitious fully <span class="math inline">\(V\)</span>-optimal rule, we
define <span class="math inline">\(S\)</span>-optimal rules as the optimal rule that considers all possible subsets
of <span class="math inline">\(V\)</span> covariates, with card(<span class="math inline">\(S\)</span>) <span class="math inline">\(\leq\)</span> card(<span class="math inline">\(V\)</span>) and <span class="math inline">\(\emptyset \in S\)</span>.</p></li>
<li><p>This allows us to consider sub-optimal rules that are easier to estimate and
potentially provide more realistic rules- as such, we allow for statistical
inference for the counterfactual mean outcome under the sub-optimal rule.</p></li>
</ul>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W4"</span>, <span class="st">"W3"</span>, <span class="st">"W2"</span>, <span class="st">"W1"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">FALSE</span>, realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit</span>
<span class="co">#&gt; A tmle3_Fit that took 1 step(s)</span>
<span class="co">#&gt;    type         param init_est tmle_est       se   lower   upper</span>
<span class="co">#&gt; 1:  TSM E[Y_{d(V=1)}]  0.48614  0.53913 0.093273 0.35632 0.72194</span>
<span class="co">#&gt;    psi_transformed lower_transformed upper_transformed</span>
<span class="co">#&gt; 1:         0.53913           0.35632           0.72194</span></code></pre></div>
<p>Even though the user specified all baseline covariates as the basis
for rule estimation, a simpler rule is sufficient to
maximize the mean under the optimal individualized treatment!</p>
<p><strong>QUESTION:</strong> How does the set of covariates picked by <code>tmle3mopttx</code>
compare to the baseline covariates the true rule depends on?</p>
</div>
<div id="realistic-optimal-individual-regimes" class="section level3">
<h3>
<span class="header-section-number">5.7.2</span> Realistic Optimal Individual Regimes<a class="anchor" aria-label="anchor" href="#realistic-optimal-individual-regimes"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><code>tmle3mopttx</code> also provides an option to estimate the mean under the
realistic, or implementable, optimal individualized treatment.</p></li>
<li><p>It is often the case that assigning particular regime might have the ability to
fully maximize (or minimize) the desired outcome, but due to
global or practical positivity constrains, such treatment
can never be implemented in real life (or is highly unlikely).</p></li>
<li><p>Specifying <code>realistic="TRUE"</code>, we consider possibly suboptimal
treatments that optimize the outcome in question while being
supported by the data.</p></li>
</ul>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W4"</span>, <span class="st">"W3"</span>, <span class="st">"W2"</span>, <span class="st">"W1"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>, realistic <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit</span>
<span class="co">#&gt; A tmle3_Fit that took 1 step(s)</span>
<span class="co">#&gt;    type         param init_est tmle_est       se   lower   upper</span>
<span class="co">#&gt; 1:  TSM E[Y_{A=NULL}]  0.54869  0.58779 0.057258 0.47557 0.70001</span>
<span class="co">#&gt;    psi_transformed lower_transformed upper_transformed</span>
<span class="co">#&gt; 1:         0.58779           0.47557           0.70001</span>

<span class="co"># How many individuals got assigned each treatment?</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmle_spec</span><span class="op">$</span><span class="va">return_rule</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   1   2   3 </span>
<span class="co">#&gt;   4 502 494</span></code></pre></div>
<p><strong>QUESTION:</strong> Referring back to the data-generating distribution, why do you
think the distribution of allocated treatment changed from the distribution
that we had under the “non-realistic” rule?</p>
</div>
<div id="variable-importance-analysis" class="section level3">
<h3>
<span class="header-section-number">5.7.3</span> Variable Importance Analysis<a class="anchor" aria-label="anchor" href="#variable-importance-analysis"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>In the previous sections we have seen how to obtain a contrast between the
mean under the optimal individualized rule and the mean under the observed outcome for a
single covariate. We are now ready to run the variable importance analysis for all of our
observed covariates!</p></li>
<li><p>In order to run <code>tmle3mopttx</code> variable importance measure, we
need considered covariates to be categorical variables.</p></li>
<li><p>For illustration purpose,
we bin baseline covariates corresponding to the data-generating distribution
described in the previous section:</p></li>
</ul>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># bin baseline covariates to 3 categories:</span>
<span class="va">data</span><span class="op">$</span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">W1</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">W1</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">W1</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">W1</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>

<span class="va">node_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W3"</span>, <span class="st">"W4"</span>, <span class="st">"W2"</span><span class="op">)</span>,
  A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"A"</span><span class="op">)</span>,
  Y <span class="op">=</span> <span class="st">"Y"</span>
<span class="op">)</span></code></pre></div>
<ul>
<li>Note that our node list now includes <span class="math inline">\(W_1\)</span> as treatments as well!
Don’t worry, we will still properly adjust for all baseline covariates when
considering <span class="math inline">\(A\)</span> as treatment.</li>
</ul>
<div id="variable-importance-using-targeted-estimation-of-the-value-of-the-itr" class="section level4">
<h4>
<span class="header-section-number">5.7.3.1</span> Variable Importance using Targeted Estimation of the value of the ITR<a class="anchor" aria-label="anchor" href="#variable-importance-using-targeted-estimation-of-the-value-of-the-itr"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>We will initialize a specification for the TMLE of our parameter of
interest (called a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling
<code>tmle3_mopttx_vim</code>.</li>
</ul>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_vim.html">tmle3_mopttx_vim</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"W2"</span><span class="op">)</span>,
  type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>,
  contrast <span class="op">=</span> <span class="st">"multiplicative"</span>,
  maximize <span class="op">=</span> <span class="cn">FALSE</span>,
  method <span class="op">=</span> <span class="st">"SL"</span>,
  complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit the TML estimator</span>
<span class="va">vim_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3_vim.html">tmle3_vim</a></span><span class="op">(</span><span class="va">tmle_spec</span>, <span class="va">data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span>,
  adjust_for_other_A <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>

<span class="fu"><a href="https://docs.ropensci.org/skimr/reference/print.html">print</a></span><span class="op">(</span><span class="va">vim_results</span><span class="op">)</span>
<span class="co">#&gt;    type                  param   init_est  tmle_est       se      lower</span>
<span class="co">#&gt; 1:   RR RR(E[Y_{A=NULL}]/E[Y])  0.0052065  0.058406 0.034144 -0.0085144</span>
<span class="co">#&gt; 2:   RR RR(E[Y_{A=NULL}]/E[Y]) -0.0239991 -0.067511 0.051592 -0.1686303</span>
<span class="co">#&gt;       upper psi_transformed lower_transformed upper_transformed  A           W</span>
<span class="co">#&gt; 1: 0.125327         1.06015           0.99152            1.1335  A W3,W4,W2,W1</span>
<span class="co">#&gt; 2: 0.033608         0.93472           0.84482            1.0342 W1  W3,W4,W2,A</span>
<span class="co">#&gt;     Z_stat     p_nz p_nz_corrected</span>
<span class="co">#&gt; 1:  1.7106 0.043578       0.087156</span>
<span class="co">#&gt; 2: -1.3085 0.095344       0.095344</span></code></pre></div>
<p>The final result of <code>tmle3_vim</code> with the <code>tmle3mopttx</code> spec is an ordered list
of mean outcomes under the optimal individualized treatment for all categorical
covariates in our dataset.</p>
</div>
</div>
</div>
<div id="exercise" class="section level2">
<h2>
<span class="header-section-number">5.8</span> Exercise<a class="anchor" aria-label="anchor" href="#exercise"><i class="fas fa-link"></i></a>
</h2>
<div id="real-world-data-and-tmle3mopttx" class="section level3">
<h3>
<span class="header-section-number">5.8.1</span> Real World Data and <code>tmle3mopttx</code><a class="anchor" aria-label="anchor" href="#real-world-data-and-tmle3mopttx"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, we cement everything we learned so far with a real data application.</p>
<p>As in the previous sections, we will be using the WASH Benefits data,
corresponding to the Effect of water quality, sanitation, hand washing, and
nutritional interventions on child development in rural Bangladesh trial.</p>
<p>The main aim of the cluster-randomized controlled trial was to assess the
impact of six intervention groups, including:</p>
<ol style="list-style-type: decimal">
<li><p>Control</p></li>
<li><p>Handwashing with soap</p></li>
<li><p>Improved nutrition through counselling and provision of lipid-based nutrient supplements</p></li>
<li><p>Combined water, sanitation, handwashing, and nutrition.</p></li>
<li><p>Improved sanitation</p></li>
<li><p>Combined water, sanitation, and handwashing</p></li>
<li><p>Chlorinated drinking water</p></li>
</ol>
<p>We aim to estimate the optimal ITR and the corresponding value under the optimal ITR
for the main intervention in WASH Benefits data!</p>
<p>Our outcome of interest is the weight-for-height Z-score, whereas our treatment is
the six intervention groups aimed at improving living conditions.</p>
<p>Questions:</p>
<ol style="list-style-type: decimal">
<li><p>Define <span class="math inline">\(V\)</span> as mother’s education (<code>momedu</code>), current living conditions (<code>floor</code>),
and possession of material items including the refrigerator (<code>asset_refrig</code>).
Why do you think we use these covariates as <span class="math inline">\(V\)</span>?
Do we want to minimize or maximize the outcome? Which blip type should we use?
Construct an appropriate <code>sl3</code> library for <span class="math inline">\(A\)</span>, <span class="math inline">\(Y\)</span> and <span class="math inline">\(B\)</span>.</p></li>
<li><p>Based on the <span class="math inline">\(V\)</span> defined in the previous question, estimate the mean under the ITR for
the main randomized intervention used in the WASH Benefits trial
with weight-for-height Z-score as the outcome. What’s the TMLE value of the optimal ITR?
How does it change from the initial estimate? Which intervention is the most dominant?
Why do you think that is?</p></li>
<li><p>Using the same formulation as in questions 1 and 2, estimate the realistic optimal ITR
and the corresponding value of the realistic ITR. Did the results change? Which intervention
is the most dominant under realistic rules? Why do you think that is?</p></li>
</ol>
</div>
</div>
<div id="summary-1" class="section level2">
<h2>
<span class="header-section-number">5.9</span> Summary<a class="anchor" aria-label="anchor" href="#summary-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>In summary, the mean outcome under the optimal individualized treatment is a counterfactual
quantity of interest representing what the mean outcome would have been if everybody, contrary
to the fact, received treatment that optimized their outcome.</p></li>
<li><p><code>tmle3mopttx</code> estimates the mean outcome under the optimal individualized treatment, where the candidate
rules are restricted to only respond to a user-supplied subset of the baseline and intermediate
covariates. In addition it provides options for realistic, data-adaptive interventions.</p></li>
<li><p>In essence, our target parameter answers the key aim of precision medicine: allocating
the available treatment by tailoring it to the individual characteristics of the patient, with the
goal of optimizing the final outcome.</p></li>
</ul>
<div id="solutions" class="section level3">
<h3>
<span class="header-section-number">5.9.1</span> Solutions<a class="anchor" aria-label="anchor" href="#solutions"><i class="fas fa-link"></i></a>
</h3>
<p>To start, let’s load the data, convert all columns to be of class <code>numeric</code>,
and take a quick look at it:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">washb_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/tlverse/tlverse-data/master/wash-benefits/washb_data.csv"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">washb_data</span> <span class="op">&lt;-</span> <span class="va">washb_data</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">momage</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">washb_data</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>As before, we specify the NPSEM via the <code>node_list</code> object.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">node_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  W <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"whz"</span>, <span class="st">"tr"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,
  A <span class="op">=</span> <span class="st">"tr"</span>, Y <span class="op">=</span> <span class="st">"whz"</span>
<span class="op">)</span></code></pre></div>
<p>We pick few potential effect modifiers, including mother’s education, current
living conditions (floor), and possession of material items including the refrigerator.
We concentrate of these covariates as they might be indicative of the socio-economic status
of individuals involved in the trial. We can explore the distribution of our <span class="math inline">\(V\)</span>, <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span>:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># V1, V2 and V3:</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">momedu</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">floor</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">asset_refrig</span><span class="op">)</span>

<span class="co"># A:</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">tr</span><span class="op">)</span>

<span class="co"># Y:</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">$</span><span class="va">whz</span><span class="op">)</span></code></pre></div>
<p>We specify a simply library for the outcome regression, propensity score
and the blip function. Since our treatment is categorical, we need to define a
multinomial learner for <span class="math inline">\(A\)</span> and multivariate learner for <span class="math inline">\(B\)</span>. We
will define the <code>xgboost</code> over a grid of parameters, and initialize a mean learner.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Initialize few of the learners:</span>
<span class="va">grid_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  nrounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span>,
  eta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">grid_params</span>, KEEP.OUT.ATTRS <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">xgb_learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">grid</span>, MARGIN <span class="op">=</span> <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">params_tune</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">Lrnr_xgboost</span><span class="op">$</span><span class="va">new</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">params_tune</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>

<span class="co">## Define the Q learner, which is just a regular learner:</span>
<span class="va">Q_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,
    <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">lrn_mean</span>
  <span class="op">)</span>,
  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Define the g learner, which is a multinomial learner:</span>
<span class="co"># specify the appropriate loss of the multinomial learner:</span>
<span class="va">mn_metalearner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_solnp</span>,
  loss_function <span class="op">=</span> <span class="va">loss_loglik_multinomial</span>,
  learner_function <span class="op">=</span> <span class="va">metalearner_linear_multinomial</span>
<span class="op">)</span>
<span class="va">g_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_sl</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">lrn_mean</span><span class="op">)</span>, <span class="va">mn_metalearner</span><span class="op">)</span>

<span class="co"># Define the Blip learner, which is a multivariate learner:</span>
<span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,
  <span class="va">xgb_learners</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>, <span class="va">lrn_mean</span>
<span class="op">)</span>
<span class="va">b_learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/create_mv_learners.html">create_mv_learners</a></span><span class="op">(</span>learners <span class="op">=</span> <span class="va">learners</span><span class="op">)</span>

<span class="va">learner_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Q_learner</span>, A <span class="op">=</span> <span class="va">g_learner</span>, B <span class="op">=</span> <span class="va">b_learner</span><span class="op">)</span></code></pre></div>
<p>As seen before, we initialize the <code>tmle3_mopttx_blip_revere</code> Spec in order to
answer Question 1. We want to maximize our outcome, with higher the weight-for-height Z-score
the better. We will also use <code>blip2</code> as the blip type, but note that we could have used <code>blip1</code>
as well since “Control” is a good reference category.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Question 2:</span>

<span class="co"># Initialize a tmle specification</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"momedu"</span>, <span class="st">"floor"</span>, <span class="st">"asset_refrig"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># Fit the TML estimator.</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, data <span class="op">=</span> <span class="va">washb_data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit</span>

<span class="co"># Which intervention is the most dominant?</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmle_spec</span><span class="op">$</span><span class="va">return_rule</span><span class="op">)</span></code></pre></div>
<p>Using the same formulation as before, we estimate the realistic optimal ITR
and the corresponding value of the realistic ITR:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Question 3:</span>

<span class="co"># Initialize a tmle specification with "realistic=TRUE":</span>
<span class="va">tmle_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tmle3mopttx/man/tmle3_mopttx_blip_revere.html">tmle3_mopttx_blip_revere</a></span><span class="op">(</span>
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"momedu"</span>, <span class="st">"floor"</span>, <span class="st">"asset_refrig"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"blip2"</span>,
  learners <span class="op">=</span> <span class="va">learner_list</span>, maximize <span class="op">=</span> <span class="cn">TRUE</span>, complex <span class="op">=</span> <span class="cn">TRUE</span>,
  realistic <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>

<span class="co"># Fit the TML estimator.</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://tlverse.org/tmle3/reference/tmle3.html">tmle3</a></span><span class="op">(</span><span class="va">tmle_spec</span>, data <span class="op">=</span> <span class="va">washb_data</span>, <span class="va">node_list</span>, <span class="va">learner_list</span><span class="op">)</span>
<span class="va">fit</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tmle_spec</span><span class="op">$</span><span class="va">return_rule</span><span class="op">)</span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tmle3.html"><span class="header-section-number">4</span> The TMLE Framework</a></div>
<div class="next"><a href="stochastic-treatment-regimes-optional.html"><span class="header-section-number">6</span> Stochastic Treatment Regimes (optional)</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#optimal-individualized-treatment-regimes-optional"><span class="header-section-number">5</span> Optimal Individualized Treatment Regimes (optional)</a></li>
<li><a class="nav-link" href="#learning-objectives-3"><span class="header-section-number">5.1</span> Learning Objectives</a></li>
<li><a class="nav-link" href="#introduction-to-optimal-individualized-interventions"><span class="header-section-number">5.2</span> Introduction to Optimal Individualized Interventions</a></li>
<li><a class="nav-link" href="#data-structure-and-notation"><span class="header-section-number">5.3</span> Data Structure and Notation</a></li>
<li>
<a class="nav-link" href="#defining-the-causal-effect-of-an-optimal-individualized-intervention"><span class="header-section-number">5.4</span> Defining the Causal Effect of an Optimal Individualized Intervention</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#why-cv-tmle"><span class="header-section-number">5.4.1</span> Why CV-TMLE?</a></li></ul>
</li>
<li>
<a class="nav-link" href="#binary-treatment"><span class="header-section-number">5.5</span> Binary Treatment</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#evaluating-the-causal-effect-of-an-optimal-itr-with-binary-treatment"><span class="header-section-number">5.5.1</span> Evaluating the Causal Effect of an optimal ITR with Binary Treatment</a></li></ul>
</li>
<li>
<a class="nav-link" href="#categorical-treatment"><span class="header-section-number">5.6</span> Categorical Treatment</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#evaluating-the-causal-effect-of-an-optimal-itr-with-categorical-treatment"><span class="header-section-number">5.6.1</span> Evaluating the Causal Effect of an optimal ITR with Categorical Treatment</a></li></ul>
</li>
<li>
<a class="nav-link" href="#extensions-to-causal-effect-of-an-oit"><span class="header-section-number">5.7</span> Extensions to Causal Effect of an OIT</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#simpler-rules"><span class="header-section-number">5.7.1</span> Simpler Rules</a></li>
<li><a class="nav-link" href="#realistic-optimal-individual-regimes"><span class="header-section-number">5.7.2</span> Realistic Optimal Individual Regimes</a></li>
<li><a class="nav-link" href="#variable-importance-analysis"><span class="header-section-number">5.7.3</span> Variable Importance Analysis</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#exercise"><span class="header-section-number">5.8</span> Exercise</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#real-world-data-and-tmle3mopttx"><span class="header-section-number">5.8.1</span> Real World Data and tmle3mopttx</a></li></ul>
</li>
<li>
<a class="nav-link" href="#summary-1"><span class="header-section-number">5.9</span> Summary</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#solutions"><span class="header-section-number">5.9.1</span> Solutions</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tlverse/tlverse-workshops/blob/master/06-tmle3mopttx.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tlverse/tlverse-workshops/edit/master/06-tmle3mopttx.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>[Workshop] Targeted Learning in the <code>tlverse</code></strong>: Causal Inference Meets Machine Learning" was written by Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips. It was last built on updated: August 16, 2021.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
